<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>STUDENT LOGIN</title>
    <link rel="icon" type="image/png" href="{{ url_for('static', filename='images/aspirematch.png') }}">
    <link href="{{ url_for('static', filename='css/output.css') }}" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="flex flex-col min-h-screen 
            bg-[#f6ebcd]
            lg:bg-none lg:bg-[#f6ebcd]">
<header class="fixed top-0 left-0 right-0 text-[#f6ebcd]
               flex flex-col lg:flex-row
               items-center lg:justify-between
               px-4 lg:px-8 py-4 lg:h-20
               z-50 text-center lg:text-left
                lg:bg-[#166D3B]">

    <!-- Logo + Title -->
    <div class="flex flex-col lg:flex-row items-center lg:space-x-3 text-[#166D3B] lg:text-[#f6ebcd]">
        <img src="/static/images/aspire.png"
             alt="AspireMatch Logo"
             class="h-14 lg:h-16 w-auto mb-2 lg:mb-0">

        <h1 class="text-lg sm:text-xl md:text-2xl lg:text-3xl font-semibold tracking-wide">
            ASPIREMATCH
            <span class="block md:inline lg:text-2xl font-semibold text-sm">
                A Career Interest Recommendation Application
            </span>
        </h1>
    </div>

    <!-- Chat Button -->
    <div class="mt-3 md:mt-0">
        <div id="chat-button"
             class="bg-[#166D3B] lg:bg-[#f6ebcd] text-[#166D3B]
                    px-5 py-2 rounded-full lg:rounded-full shadow-lg
                    cursor-pointer text-sm md:text-base
                    mx-auto md:mx-0">üí¨
        </div>

        <div id="chat-panel"
            class="hidden fixed
                    text-start
                    bottom-4 right-2
                    top-48 md:top-24 md:right-6
                    w-80 md:w-96
                    h-[60vh] md:h-[80vh]
                    bg-white rounded-t-xl md:rounded-xl
                    shadow-xl p-3 md:p-4
                    flex flex-col z-50">

            <div id="chat-messages" class="flex-1 overflow-y-auto pb-2"></div>

            <div id="typingIndicator"
                class="hidden p-1 text-xs text-gray-600 italic">
                Dan is typing...
            </div>

            <div class="mt-2 flex sticky bottom-0 bg-white pt-2">
                <input id="chat-input"
                    class="flex-grow text-[#166D3B] p-2 border border-black rounded-l text-sm md:text-base"
                    placeholder="Ask Dan...">

                <button id="chat-send"
                    class="bg-[#166D3B] text-white px-4 rounded-r text-sm md:text-base">
                    Send
                </button>
            </div>
        </div>
    </div>
</header>

<!-- MAIN CONTENT -->
<main class="flex-grow flex justify-center items-center
             pt-10 sm:pt-0 md:pt-14
             px-4">
    <div
        class="bg-white p-6 sm:p-10 md:p-14 lg:p-10
               rounded-lg shadow-lg
               w-full sm:w-[90%] md:w-[70%] lg:w-1/2
               flex flex-col items-center">

        <img src="{{ url_for('static', filename='images/logo.png') }}"
             alt="Logo"
             class="h-20 md:h-24 mb-4">

        <h2 class="text-lg sm:text-xl md:text-2xl font-bold text-center text-black mb-6">
            Log In to access your Account
        </h2>

        <form class="w-full" method="POST" action="{{ url_for('student.studentlogin') }}">

            {% if error %}
            <div id="loginError"
                class="mb-4 text-center transition-opacity duration-500">
                <p class="text-red-600 font-semibold">
                    {{ error }}
                </p>
            </div>
            {% endif %}

            <div class="mb-4">
                <label class="block text-[#166D3B] text-sm md:text-base">
                    Examination ID
                </label>
                <input type="text" name="exam_id"
                    value="{{ exam_id if exam_id }}"
                    class="w-full p-2 rounded-md border
                            {{ 'border-red-600' if exam_error else 'border-black' }}"
                    required>

                <label class="block text-[#166D3B] mt-3 text-sm md:text-base">
                    Email
                </label>
                <input type="email" name="email"
                    value="{{ email if email }}"
                    class="w-full p-2 rounded-md border
                            {{ 'border-red-600' if email_error else 'border-black' }}"
                    required>
            </div>

            <button type="submit"
                class="bg-[#166D3B] text-white w-full p-2 rounded-md mt-6
                       tracking-widest text-sm md:text-base">
                Login
            </button>
        </form>
    </div>
</main>

<script>
const $ = id => document.getElementById(id);

document.getElementById("chat-button").onclick = () => {
    $("chat-panel").classList.toggle("hidden");
};

document.getElementById("chat-send").onclick = async () => {
    let msgInput = $("chat-input");
    let msg = msgInput.value.trim();
    if (!msg) return;

    addMessage("you", escapeHtml(msg));
    msgInput.value = "";

    showTyping();

    try {
        let res = await fetch("/chatbot", {
            method: "POST",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify({ message: msg })
        });
        let data = await res.json();

        setTimeout(() => {
            hideTyping();
            addMessage("dan", data.reply);
        }, 800);
    } catch (err) {
        hideTyping();
        addMessage("dan", "Sorry ‚Äî I couldn't reach the assistant right now. Try again.");
        console.error(err);
    }
};

function addMessage(sender, textHtml) {
    let messagesDiv = $("chat-messages");

    if (sender === "dan") {
        messagesDiv.innerHTML += `
            <div class='p-2 md:p-3 bg-[#166D3B] text-white rounded-lg mb-2 text-sm md:text-base max-w-[90%]'>
                Dan: ${textHtml}
            </div>
        `;
    } else {
        messagesDiv.innerHTML += `
            <div class='p-2 md:p-3 bg-gray-200 rounded-lg text-[#166D3B] mb-2 text-sm md:text-base max-w-[90%] self-end'>
                You: ${textHtml}
            </div>
        `;
    }

    messagesDiv.scrollTop = messagesDiv.scrollHeight;
}

function showTyping() {
    $("typingIndicator").classList.remove("hidden");
}
function hideTyping() {
    $("typingIndicator").classList.add("hidden");
}

function openChat() {
    $("chat-panel").classList.remove("hidden");
}

function closeChat(clearMessages = false) {
    $("chat-panel").classList.add("hidden");

    if (clearMessages) {
        $("chat-messages").innerHTML = "";
        hideTyping();
    }
}

function escapeHtml(unsafe) {
    return unsafe
         .replace(/&/g, "&amp;")
         .replace(/</g, "&lt;")
         .replace(/>/g, "&gt;")
         .replace(/"/g, "&quot;")
         .replace(/'/g, "&#039;");
}

const GUIDE_STEPS = [
    {
        title: "Welcome to AspireMatch",
        body: `
            <p>Welcome! This walkthrough will show you how AspireMatch works.</p>
            <ul class="list-disc ml-4">
                <li>Discover recommended college programs</li>
                <li>Use your exam ID to view personalized results</li>
            </ul>
        `
    },
    {
        title: "Step 1 ‚Äî Logging In",
        body: `
            <p>To access your results:</p>
            <ol class="list-decimal ml-4">
                <li>Enter your <b>Examination ID</b> (provided by your school).</li>
                <li>Enter the <b>Email</b> you registered with.</li>
                <li>Click <b>Login</b>.</li>
            </ol>
        `
    },
    {
        title: "Step 2 ‚Äî Taking / Viewing the Assessment",
        body: `
            <p>After logging in:</p>
            <ul class="list-disc ml-4">
                <li>Take the career interest assessment (if not already completed).</li>
                <li>If you've completed it, view your predicted programs and detailed feedback.</li>
            </ul>
        `
    },
    {
        title: "Step 3 ‚Äî Understanding Your Results",
        body: `
            <p>Your results include:</p>
            <ul class="list-disc ml-4">
                <li><b>Top recommended programs</b> based on your responses.</li>
                <li>Short explanations about why each program suits you.</li>
                <li>Tips on next steps (courses, skills to develop).</li>
            </ul>
        `
    },
    {
        title: "Step 4 ‚Äî Using the Chat Assistant (Dan)",
        body: `
            <p>Dan can help you:</p>
            <ul class="list-disc ml-4">
                <li>Explain your result details.</li>
                <li>Guide you through the interface.</li>
                <li>Answer common questions about programs and next steps.</li>
            </ul>
            <p>Try typing <i>‚Äúexplain my top program‚Äù</i> or <i>‚ÄúCan I retake the survey?‚Äù</i></p>
        `
    },
    {
        title: "Step 5 ‚Äî Support & Next Steps",
        body: `
            <p>If you need human support:</p>
            <ul class="list-disc ml-4">
                <li>Contact your school's admin or the AspireMatch support team.</li>
                <li>Save or download your results for future reference.</li>
            </ul>
            <p>That's it ‚Äî good luck exploring your interests! üéì</p>
        `
    }
];

let currentGuideIndex = 0;

function showGuideStep(index) {
    if (index < 0) index = 0;
    if (index >= GUIDE_STEPS.length) index = GUIDE_STEPS.length - 1;
    currentGuideIndex = index;

    const step = GUIDE_STEPS[index];

    const backDisabled = index === 0 ? "opacity-50 cursor-not-allowed" : "";
    const nextText = index === GUIDE_STEPS.length - 1 ? "Finish" : "Next";

    const html = `
        <div style="font-weight:600; margin-bottom:4px;">${escapeHtml(step.title)}</div>
        <div style="font-size:13px; margin-bottom:8px;">${step.body}</div>

        <div style="display:flex; gap:8px; margin-top:6px;">
            <button data-chat-action="true" onclick="window.guideBack()" class="px-3 py-1 rounded border ${backDisabled}">
            Back
            </button>

            <button data-chat-action="true" onclick="window.guideNext()" class="px-3 py-1 rounded border bg-[#166D3B] text-white">
            ${nextText}
            </button>

            <button data-chat-action="true" onclick="window.endGuide()" class="px-3 py-1 rounded border">
            Close
            </button>
        </div>
    `;

    const messagesDiv = $("chat-messages");

    const existing = messagesDiv.querySelector(".aspire-guide-placeholder");
    if (existing) existing.remove();

    messagesDiv.innerHTML += `
        <div class="aspire-guide-placeholder p-2 bg-[#166D3B] text-white rounded mb-2">
            Dan: ${html}
        </div>
    `;

    messagesDiv.scrollTop = messagesDiv.scrollHeight;
}

window.guideNext = () => {
    if (currentGuideIndex < GUIDE_STEPS.length - 1) {
        showGuideStep(currentGuideIndex + 1);
    } else {
        endGuide();
    }
};
window.guideBack = () => {
    if (currentGuideIndex > 0) showGuideStep(currentGuideIndex - 1);
};

function startGuide(autostart = false) {
    openChat();

    const messagesDiv = $("chat-messages");
    const existing = messagesDiv.querySelector(".aspire-guide-placeholder");
    if (existing) existing.remove();

    showTyping();
    setTimeout(() => {
        hideTyping();
        showGuideStep(0);

        if (!autostart) {
            addMessage("dan", "I've started a quick step-by-step guide ‚Äî use Next / Back to navigate.");
        }
    }, 800);
}

window.endGuide = () => {
    const messagesDiv = $("chat-messages");
    const existing = messagesDiv.querySelector(".aspire-guide-placeholder");
    if (existing) existing.remove();

    addMessage("dan", "Guide closed. If you want to run it again click Help or type 'guide'.");
};

const originalSend = document.getElementById("chat-send").onclick;
(function interceptHelp() {
    const sendBtn = $("chat-send");
    const origHandler = sendBtn.onclick;
    sendBtn.onclick = async function (ev) {
        if (origHandler) await origHandler.call(this, ev);

        const messagesDiv = $("chat-messages");
        const lastYou = Array.from(messagesDiv.querySelectorAll("div"))
            .reverse()
            .find(n => n.innerText?.startsWith("You:"));
        if (!lastYou) return;

        const content = lastYou.innerText.replace(/^You:\s*/, "").trim().toLowerCase();
        if (["help", "guide", "start guide"].includes(content)) {
            startGuide();
        }
    };
})();

window.addEventListener("load", () => {
    openChat();

    const panel = $("chat-panel");
    if (panel && !$("aspire-help-button")) {

        const closeBtn = document.createElement("button");
        closeBtn.innerHTML = "‚úï";
        closeBtn.className = "text-lg font-bold text-gray-600 hover:text-red-600 px-2";
        closeBtn.title = "Close chat";
        closeBtn.onclick = () => closeChat(true);

        const headerContainer = document.createElement("div");
        headerContainer.className = "flex items-center justify-between mb-2";

        const title = document.createElement("div");
        title.className = "font-semibold text-sm text-black";
        title.textContent = "Chat with Dan";

        headerContainer.appendChild(title);
        headerContainer.appendChild(closeBtn);

        panel.prepend(headerContainer);
    }

    showTyping();
    setTimeout(() => {
        hideTyping();
        addMessage("dan", "Hello! I'm <b>Dan</b>, your AspireMatch virtual assistant. üòä");
    }, 800);

    setTimeout(() => {
        showTyping();
        setTimeout(() => {
            hideTyping();
            addMessage("dan", "AspireMatch is a <b>Career Interest Recommendation System</b> designed to help students discover recommended programs based on their strengths and preferences.");
        }, 1000);
    }, 1800);

    setTimeout(() => {
        showTyping();
        setTimeout(() => {
            hideTyping();
            addMessage("dan",
                `Would you like a quick step-by-step tour? 
                <button data-chat-action="true"
                        onclick="startGuide()"
                        class="px-2 py-1 rounded border">
                Start Guide
                </button>`
            );
        }, 900);
    }, 3200);
});

document.addEventListener("click", function (event) {
    const chatPanel = document.getElementById("chat-panel");
    const chatButton = document.getElementById("chat-button");

    if (chatPanel.classList.contains("hidden")) return;

    if (
        chatPanel.contains(event.target) ||
        chatButton.contains(event.target) ||
        event.target.closest("[data-chat-action]")
    ) {
        return;
    }

    closeChat(false);
});

    setTimeout(() => {
        const errorBox = document.getElementById("loginError");
        if (errorBox) {
            errorBox.style.opacity = "0";
            setTimeout(() => errorBox.remove(), 500);
        }
    }, 10000);
</script>


</body>
</html>
